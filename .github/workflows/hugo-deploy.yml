name: Hugo Deploy

on:
  workflow_call:
    inputs:
      website_repository:
        required: true
        type: string
      slack_channel:
        required: true
        type: string
    secrets:
      slack_webhook:
        required: true
      aws_access_key_id:
        required: true
      aws_secret_access_key:
        required: true
      access_token:
        required: true
jobs:
  slackNotification:
    name: Slack Notification
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Slack Notification
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.slack_webhook }}
        SLACK_CHANNEL: ${{ inputs.slack_channel }}
        SLACK_COLOR: ${{ job.status }} # or a specific color like 'good' or '#ff00ff'
        SLACK_ICON: https://github.com/rtCamp.png?size=48
        SLACK_USERNAME: github-action-slack-notify
  deploywebsite:
    name: "Deploy Website"
    runs-on: ubuntu-latest
    env:
      working-directory: ./gatsby
      node-version: "15.10.0"
      SLACK_WEBHOOK: ${{ secrets.slack_webhook }}
      SLACK_CHANNEL: ${{ inputs.slack_channel }}
      SLACK_ICON: https://github.com/rtCamp.png?size=48
      SLACK_TITLE: Deployed Website
      SLACK_USERNAME: github-action-slack-notify
    strategy:
      matrix:
        node-version: [15.x]
    steps:
      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_MESSAGE: 'Deploying website :earth_americas:'
          SLACK_COLOR: ${{ job.status }} # or a specific color like 'good' or '#ff00ff'
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.aws_access_key_id }}
          aws-secret-access-key: ${{ secrets.aws_secret_access_key }}
          aws-region: us-east-1

      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: ${{ inputs.website_repository }}
          token: ${{ secrets.ACCESS_TOKEN }}

      - name: List Files
        run: |
          ls -al

      # https://github.com/tcort/markdown-link-check
      # - name: Check Links
      #   uses: gaurav-nelson/github-action-markdown-link-check@v1

      # https://github.com/xom9ikk/dotenv
      - name: Simple Dotenv
        uses: xom9ikk/dotenv@v1.0.2

      - name: Set Default Git Branch
        run: |
          git config --global init.defaultBranch master

      # https://github.com/peaceiris/actions-hugo
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2.6.0
        with:
          hugo-version: '0.110.0'
          # extended: true

      - name: Build
        timeout-minutes: 15
        run: rm -rf ./hugo/public/* && cd ./hugo && hugo --minify --cleanDestinationDir

      - name: S3 Sync
        run: aws s3 sync ./hugo/public s3://${{ env.S3_BUCKET_NAME }} --delete --acl bucket-owner-full-control --acl public-read --cache-control max-age=31536000,public

      - name: Cloudfront Invalidate
        run: aws cloudfront create-invalidation --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"

      - name: Audit URLs using Lighthouse
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: |
            ${{ env.SITE_META_URL }}
          budgetPath: ./budget.json # test performance budgets
          uploadArtifacts: true # save results as an action artifacts
          temporaryPublicStorage: true # upload lighthouse report to the temporary

      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_MESSAGE: 'Deployed website ${{env.working-directory}} :earth_americas:'
          SLACK_COLOR: ${{ job.status }} # or a specific color like 'good' or '#ff00ff'

      - name: Cleanup
        uses: rtCamp/action-cleanup@master          
