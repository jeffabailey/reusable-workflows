name: Hugo Deploy

on:
  workflow_call:
    inputs:
      website_repository:
        required: true
        type: string
      s3_bucket_name:
        required: true
        type: string
      cloudfront_distribution_id:
        required: true
        type: string
      debug:
        required: false
        type: boolean
        default: false
    secrets:
      aws_access_key_id:
        required: true
      aws_secret_access_key:
        required: true
      access_token:
        required: true

jobs:
  deploywebsite:
    name: "Deploy Website"
    runs-on: ubuntu-latest

    # Hugo's own cache dir (for modules / remote resources)
    env:
      HUGO_CACHEDIR: /tmp/hugo_cache

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.aws_access_key_id }}
          aws-secret-access-key: ${{ secrets.aws_secret_access_key }}
          aws-region: us-east-1

      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.website_repository }}
          token: ${{ secrets.access_token }}
          fetch-depth: 1

      # Load env vars from .env (same as before)
      - name: Simple Dotenv
        uses: xom9ikk/dotenv@v1.0.2
        with:
          path: ./

      - name: Set Default Git Branch
        run: git config --global init.defaultBranch master

      # Setup Hugo (pin to the version you're actually using from the log)
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2.6.0
        with:
          hugo-version: '0.154.5'
          extended: true

      - name: Get Hugo version
        id: hugo-version
        working-directory: ./hugo
        run: |
          HUGO_VERSION=$(hugo version | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "latest")
          echo "version=$HUGO_VERSION" >> "$GITHUB_OUTPUT"

      # Cache Hugo's processed resources (_gen directory)
      # Keyed only on Hugo version + config/layouts/themes/assets so
      # normal content edits don't invalidate the cache.
      - name: Cache Hugo resources
        uses: actions/cache@v4
        with:
          path: ./hugo/resources/_gen
          key: >
            ${{ runner.os }}-hugo-resources-${{ steps.hugo-version.outputs.version }}-
            ${{ hashFiles('hugo/hugo.toml', 'hugo/config.*', 'hugo/layouts/**', 'hugo/themes/**', 'hugo/assets/**') }}
          restore-keys: |
            ${{ runner.os }}-hugo-resources-${{ steps.hugo-version.outputs.version }}-
            ${{ runner.os }}-hugo-resources-

      # Optional: cache Hugo module / remote resource cache
      # Safe even if you aren't using modules; it will just be small.
      - name: Cache Hugo module cache
        uses: actions/cache@v4
        with:
          path: ${{ env.HUGO_CACHEDIR }}
          key: >
            ${{ runner.os }}-hugo-mod-${{ steps.hugo-version.outputs.version }}-
            ${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-hugo-mod-${{ steps.hugo-version.outputs.version }}-
            ${{ runner.os }}-hugo-mod-

      - name: Build
        working-directory: ./hugo
        timeout-minutes: 15
        run: |
          if [ "${{ inputs.debug }}" = "true" ]; then
            echo "ğŸ› Debug mode enabled - running Hugo with verbose output"
            hugo --minify --gc --verbose
          else
            hugo --minify --gc
          fi

      - name: S3 Sync
        run: |
          if [ "${{ inputs.debug }}" = "true" ]; then
            echo "ğŸ› Debug mode enabled - running S3 sync with verbose output"
            aws s3 sync ./hugo/public s3://${{ inputs.s3_bucket_name }} \
              --delete \
              --acl public-read \
              --cache-control max-age=31536000,public
          else
            aws s3 sync ./hugo/public s3://${{ inputs.s3_bucket_name }} \
              --delete \
              --acl public-read \
              --cache-control max-age=31536000,public \
              --only-show-errors
          fi

      - name: Cloudfront Invalidate
        run: |
          if [ "${{ inputs.debug }}" = "true" ]; then
            echo "ğŸ› Debug mode enabled - running CloudFront invalidation with verbose output"
            aws cloudfront create-invalidation \
              --distribution-id ${{ inputs.cloudfront_distribution_id }} \
              --paths "/*" \
              --debug
          else
            aws cloudfront create-invalidation \
              --distribution-id ${{ inputs.cloudfront_distribution_id }} \
              --paths "/*"
          fi

      - name: Cleanup
        uses: rtCamp/action-cleanup@master
