name: Generate Markdown Links

on:
  workflow_call:
    inputs:
      website_repository:
        required: true
        type: string
      content_folder:
        required: false
        type: string
        default: "hugo/content/blog"
        description: "Path to content folder relative to repository root (e.g., 'hugo/content/blog' or 'content/blog')"
      prompt_file:
        required: false
        type: string
        default: ".cursor/seo_optimize.md"
      custom_prompt:
        required: false
        type: string
        description: "Custom prompt to override the default prompt file"
      debug:
        required: false
        type: boolean
        default: false
    secrets:
      access_token:
        required: true
      COPILOT_GITHUB_TOKEN:
        required: true
        description: "GitHub token with Copilot API access (must be named COPILOT_GITHUB_TOKEN)"

jobs:
  generateLinks:
    name: "Generate Markdown Links"
    runs-on: ubuntu-latest

    steps:
      - name: Display Token for Verification
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
        run: |
          # Only use COPILOT_GITHUB_TOKEN secret - no GITHUB_TOKEN fallback
          TOKEN="${{ secrets.COPILOT_GITHUB_TOKEN }}"
          TOKEN_SOURCE="COPILOT_GITHUB_TOKEN secret"
          
          echo "Token source: ${TOKEN_SOURCE}"
          if [ -n "$TOKEN" ]; then
            TOKEN_LEN=${#TOKEN}
            if [ $TOKEN_LEN -gt 8 ]; then
              TOKEN_PREFIX="${TOKEN:0:8}"
              TOKEN_SUFFIX="${TOKEN: -8}"
              echo "Token verification (first 8 + last 8 chars): ${TOKEN_PREFIX}...${TOKEN_SUFFIX}"
              echo "Token length: ${TOKEN_LEN} characters"
              echo "Token prefix: ${TOKEN_PREFIX}"
            else
              echo "Token length: ${TOKEN_LEN} characters (too short to display safely)"
            fi
          else
            echo "❌ COPILOT_GITHUB_TOKEN secret is not configured"
            echo "   Please set the 'COPILOT_GITHUB_TOKEN' secret in repository Settings > Secrets and variables > Actions"
            exit 1
          fi

      - name: Checkout reusable workflows
        uses: actions/checkout@v4
        with:
          repository: jeffabailey/reusable-workflows
          # Using access_token ensures access even if repo is private
          # Note: 500 errors are transient GitHub issues and will auto-retry
          token: ${{ secrets.access_token }}
          fetch-depth: 1
          path: reusable-workflows

      - name: Checkout website repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.website_repository }}
          token: ${{ secrets.access_token }}
          fetch-depth: 1
          path: website

      - name: Set Default Git Branch
        run: git config --global init.defaultBranch master

      - name: Install GitHub Copilot CLI
        run: |
          if command -v copilot > /dev/null 2>&1; then
            echo "✅ GitHub Copilot CLI is already installed"
            copilot --version || true
          else
            echo "Installing GitHub Copilot CLI via npm..."
            # Install via npm (recommended method)
            # Package name: @github/copilot (requires Node.js v22+)
            npm install -g @github/copilot || {
              echo "❌ Failed to install Copilot CLI via npm"
              echo "   Attempting alternative installation method..."
              # Alternative: try installing via GitHub CLI extension
              if command -v gh > /dev/null 2>&1; then
                echo "   GitHub CLI is available, but Copilot CLI must be installed separately"
                echo "   Please install Copilot CLI manually or ensure it's available in PATH"
                exit 1
              else
                echo "   Neither npm nor gh are available"
                exit 1
              fi
            }
            echo "✅ Copilot CLI installed successfully"
          fi

      - name: Verify GitHub Copilot CLI
        run: |
          if command -v copilot > /dev/null 2>&1; then
            echo "✅ GitHub Copilot CLI is available"
            copilot --version || true
          else
            echo "❌ GitHub Copilot CLI is not available"
            echo "   This workflow requires GitHub Copilot subscription and the Copilot CLI"
            echo "   Please ensure GitHub Copilot is enabled and the CLI is installed"
            exit 1
          fi

      - name: Verify Copilot CLI Authentication
        run: |
          # Check if COPILOT_GITHUB_TOKEN secret is configured
          # Only use COPILOT_GITHUB_TOKEN - no GITHUB_TOKEN fallback
          COPILOT_TOKEN="${{ secrets.COPILOT_GITHUB_TOKEN }}"
          
          if [ -z "$COPILOT_TOKEN" ]; then
            echo "❌ COPILOT_GITHUB_TOKEN secret is not configured"
            echo ""
            echo "The Copilot CLI requires the 'COPILOT_GITHUB_TOKEN' secret to be set."
            echo ""
            echo "To configure:"
            echo "  1. Go to repository Settings > Secrets and variables > Actions"
            echo "  2. Add a new secret named 'COPILOT_GITHUB_TOKEN'"
            echo "  3. Value: A Personal Access Token with Copilot permissions"
            echo ""
            echo "To create a Personal Access Token:"
            echo "  1. Go to GitHub Settings > Developer settings > Personal access tokens > Tokens (classic)"
            echo "  2. Generate a new token (classic) with 'repo' scope"
            echo "  3. Add it as a repository secret named 'COPILOT_GITHUB_TOKEN'"
            echo ""
            exit 1
          else
            echo "✅ COPILOT_GITHUB_TOKEN secret is configured"
          fi

      - name: Test Copilot CLI Authentication
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
        run: |
          echo "Testing Copilot CLI authentication using COPILOT_GITHUB_TOKEN..."
          # Test with a simple prompt to verify authentication works
          # Copilot CLI checks COPILOT_GITHUB_TOKEN first, so we prioritize that
          if [ -z "$COPILOT_GITHUB_TOKEN" ]; then
            echo "❌ COPILOT_GITHUB_TOKEN is not set"
            exit 1
          fi
          
          # Test copilot CLI with a minimal prompt using COPILOT_GITHUB_TOKEN
          # This will fail immediately if authentication doesn't work
          if copilot -p "test" --allow-all-tools --silent > /dev/null 2>&1; then
            echo "✅ Copilot CLI authentication test passed (using COPILOT_GITHUB_TOKEN)"
          else
            echo "❌ Copilot CLI authentication test failed"
            echo ""
            echo "The COPILOT_GITHUB_TOKEN is set but copilot CLI cannot authenticate with it."
            echo "This may indicate:"
            echo "  • The token has expired"
            echo "  • The token doesn't have Copilot permissions"
            echo "  • The token is invalid or incorrect"
            echo ""
            echo "Please verify your token has Copilot permissions and is valid."
            exit 1
          fi

      - name: Setup Node.js (for Copilot CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml requests

      - name: Read default prompt
        id: read-prompt
        working-directory: ./website
        run: |
          PROMPT_FILE="${{ inputs.prompt_file }}"
          if [ -f "$PROMPT_FILE" ]; then
            # Use multiline output to preserve formatting
            {
              echo 'prompt<<EOF'
              cat "$PROMPT_FILE"
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
            echo "✅ Successfully read prompt from $PROMPT_FILE"
          else
            echo "⚠️  Prompt file not found at $PROMPT_FILE"
            echo "   Current directory: $(pwd)"
            echo "   Available files in .cursor/:"
            ls -la .cursor/ 2>/dev/null || echo "   .cursor/ directory does not exist"
            echo "prompt=No prompt file found at $PROMPT_FILE" >> "$GITHUB_OUTPUT"
          fi

      - name: Copy script to website repository
        run: |
          # Verify source directory exists
          if [ ! -d "reusable-workflows/.github/workflows/generate-links" ]; then
            echo "Error: Script directory not found at reusable-workflows/.github/workflows/generate-links"
            echo "Listing reusable-workflows directory:"
            ls -la reusable-workflows/ || true
            echo "Listing reusable-workflows/.github directory:"
            ls -la reusable-workflows/.github/ || true
            echo "Listing reusable-workflows/.github/workflows directory:"
            ls -la reusable-workflows/.github/workflows/ || true
            exit 1
          fi
          # Create destination directory
          mkdir -p website/.github/workflows/generate-links
          # Copy all files from source to destination
          cp -r reusable-workflows/.github/workflows/generate-links/. website/.github/workflows/generate-links/
          # Make script executable
          if [ -f "website/.github/workflows/generate-links/generate_links.py" ]; then
            chmod +x website/.github/workflows/generate-links/generate_links.py
          else
            echo "Error: generate_links.py not found after copy"
            exit 1
          fi
          echo "✅ Successfully copied script to website repository"

      - name: Generate markdown links
        working-directory: ./website
        env:
          # Only use COPILOT_GITHUB_TOKEN - copilot CLI checks this first
          # No GITHUB_TOKEN or GH_TOKEN - only COPILOT_GITHUB_TOKEN
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          CONTENT_FOLDER: ${{ inputs.content_folder }}
          CUSTOM_PROMPT: ${{ inputs.custom_prompt }}
          DEFAULT_PROMPT: ${{ steps.read-prompt.outputs.prompt }}
          DEBUG: ${{ inputs.debug }}
        run: |
          python3 .github/workflows/generate-links/generate_links.py

      - name: Configure Git
        working-directory: ./website
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for changes
        id: check-changes
        working-directory: ./website
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit changes
        if: steps.check-changes.outputs.changes == 'true'
        working-directory: ./website
        run: |
          git add -A
          git commit -m "chore: generate markdown links via GitHub Copilot" || exit 0
          git push || echo "Warning: Failed to push changes. This may be expected if the branch is protected."

      - name: Summary
        run: |
          if [ "${{ steps.check-changes.outputs.changes }}" == "true" ]; then
            echo "✅ Successfully generated and committed markdown links"
          else
            echo "ℹ️ No changes were made to markdown files"
          fi
