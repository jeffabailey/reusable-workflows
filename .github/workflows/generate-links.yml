name: Generate Markdown Links

on:
  workflow_call:
    inputs:
      website_repository:
        required: true
        type: string
      content_folder:
        required: false
        type: string
        default: "hugo/content/blog"
        description: "Path to content folder relative to repository root (e.g., 'hugo/content/blog' or 'content/blog')"
      prompt_file:
        required: false
        type: string
        default: ".cursor/seo_optimize.md"
      custom_prompt:
        required: false
        type: string
        description: "Custom prompt to override the default prompt file"
      debug:
        required: false
        type: boolean
        default: false
    secrets:
      access_token:
        required: true
      copilot_token:
        required: true
        description: "GitHub token with Copilot API access"

jobs:
  generateLinks:
    name: "Generate Markdown Links"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout reusable workflows
        uses: actions/checkout@v4
        with:
          repository: jeffabailey/reusable-workflows
          token: ${{ secrets.access_token }}
          fetch-depth: 1
          path: reusable-workflows

      - name: Checkout website repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.website_repository }}
          token: ${{ secrets.access_token }}
          fetch-depth: 1
          path: website

      - name: Set Default Git Branch
        run: git config --global init.defaultBranch master

      - name: Verify GitHub Copilot CLI
        run: |
          if command -v copilot > /dev/null 2>&1; then
            echo "✅ GitHub Copilot CLI is available"
            copilot --version || true
          else
            echo "❌ GitHub Copilot CLI is not available"
            echo "   This workflow requires GitHub Copilot subscription and the Copilot CLI"
            echo "   Please ensure GitHub Copilot is enabled and the CLI is installed"
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml requests

      - name: Read default prompt
        id: read-prompt
        working-directory: ./website
        run: |
          PROMPT_FILE="${{ inputs.prompt_file }}"
          if [ -f "$PROMPT_FILE" ]; then
            # Use multiline output to preserve formatting
            {
              echo 'prompt<<EOF'
              cat "$PROMPT_FILE"
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
            echo "✅ Successfully read prompt from $PROMPT_FILE"
          else
            echo "⚠️  Prompt file not found at $PROMPT_FILE"
            echo "   Current directory: $(pwd)"
            echo "   Available files in .cursor/:"
            ls -la .cursor/ 2>/dev/null || echo "   .cursor/ directory does not exist"
            echo "prompt=No prompt file found at $PROMPT_FILE" >> "$GITHUB_OUTPUT"
          fi

      - name: Copy script to website repository
        run: |
          # Verify source directory exists
          if [ ! -d "reusable-workflows/.github/workflows/generate-links" ]; then
            echo "Error: Script directory not found at reusable-workflows/.github/workflows/generate-links"
            echo "Listing reusable-workflows directory:"
            ls -la reusable-workflows/ || true
            echo "Listing reusable-workflows/.github directory:"
            ls -la reusable-workflows/.github/ || true
            echo "Listing reusable-workflows/.github/workflows directory:"
            ls -la reusable-workflows/.github/workflows/ || true
            exit 1
          fi
          # Create destination directory
          mkdir -p website/.github/workflows/generate-links
          # Copy all files from source to destination
          cp -r reusable-workflows/.github/workflows/generate-links/. website/.github/workflows/generate-links/
          # Make script executable
          if [ -f "website/.github/workflows/generate-links/generate_links.py" ]; then
            chmod +x website/.github/workflows/generate-links/generate_links.py
          else
            echo "Error: generate_links.py not found after copy"
            exit 1
          fi
          echo "✅ Successfully copied script to website repository"

      - name: Generate markdown links
        working-directory: ./website
        env:
          GITHUB_TOKEN: ${{ secrets.copilot_token }}
          CONTENT_FOLDER: ${{ inputs.content_folder }}
          CUSTOM_PROMPT: ${{ inputs.custom_prompt }}
          DEFAULT_PROMPT: ${{ steps.read-prompt.outputs.prompt }}
          DEBUG: ${{ inputs.debug }}
        run: |
          python3 .github/workflows/generate-links/generate_links.py

      - name: Configure Git
        working-directory: ./website
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for changes
        id: check-changes
        working-directory: ./website
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit changes
        if: steps.check-changes.outputs.changes == 'true'
        working-directory: ./website
        run: |
          git add -A
          git commit -m "chore: generate markdown links via GitHub Copilot" || exit 0
          git push || echo "Warning: Failed to push changes. This may be expected if the branch is protected."

      - name: Summary
        run: |
          if [ "${{ steps.check-changes.outputs.changes }}" == "true" ]; then
            echo "✅ Successfully generated and committed markdown links"
          else
            echo "ℹ️ No changes were made to markdown files"
          fi
